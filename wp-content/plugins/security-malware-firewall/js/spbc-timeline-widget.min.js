class SpbcTimelineWidget{static markerRadius=4;static hoursRangeMax=24;static axisStepsCount=6;static userActionsUpstep=12;static legendCircleX=-120;static legendTextX=-105;constructor(){this.now=new Date,this.currentTimestamp=Math.floor(this.now.getTime()/1e3),this.eventsData=null,this.timelineMarkersData=[],this.timelineKnownEventsData=[],this.timelineEventTooltip=null,this.timelineStartTimestamp=this.currentTimestamp-3600*SpbcTimelineWidget.hoursRangeMax,this.usersCount=0,this.summaryEventsCount=0}render(){var e;"undefined"!=typeof spbcTimelineWidgetData&&(this.timelineEventTooltip=document.getElementById("spbc-timeline-tooltip"),this.eventsData=spbcTimelineWidgetData.users_actions,this.timelineStartTimestamp=Number(spbcTimelineWidgetData.first_event_timestamp),this.timelineKnownEventsData=spbcTimelineWidgetData.known_events_data,this.timelineMarkersData=this.generateMarkersData(spbcTimelineWidgetData.found_types),(e=document.querySelector(".spbc_tab_section--active"))&&"spbc_tab-security_log"===e.id&&this.initTimeline(),window.addEventListener("spbctTabLoaded",e=>{"security_log"===e.detail.tab&&this.initTimeline()}),jQuery("#spbc-timeline-tab").on("click",e=>{e.hasOwnProperty("originalEvent")&&("1"!==localStorage.getItem("spbc_timeline_closed")?localStorage.setItem("spbc_timeline_closed","1"):localStorage.setItem("spbc_timeline_closed","0"))}),window.addEventListener("resize",()=>{var e=document.getElementById("spbc-timeline-user-select");e.value&&this.drawUserTimeline(e.value)}))}initTimeline(){let t=document.getElementById("spbc-timeline-user-select");var e,i=Object.keys(this.eventsData);for(e in this.eventsData)this.eventsData.hasOwnProperty(e)&&(this.usersCount++,this.summaryEventsCount+=this.eventsData[e].length);t.innerHTML="",i.forEach(e=>{t.appendChild(new Option(e,e))}),t.addEventListener("change",()=>{this.drawUserTimeline(t.value)}),0<i.length?this.drawUserTimeline(i[0]):(document.querySelector(".spbc-timeline-container").style.display="none",document.querySelector(".spbc-timeline-controls").style.display="none",document.getElementById("spbc-timeline-no-data").style.display="block");i=jQuery("#spbc_timeline_activity_counters")[0],i.innerText=i.innerText.replace("%users_count%",this.usersCount.toString()).replace("%events_count%",this.summaryEventsCount.toString()),i="1"===localStorage.getItem("spbc_timeline_closed");i||setTimeout(function(){jQuery("#spbc-timeline-tab").trigger("click")},200)}drawTimeAxis(t,i,n){var s=this.currentTimestamp-this.timelineStartTimestamp,e=document.createElementNS("http://www.w3.org/2000/svg","line");n+=10,e.setAttribute("class","spbc-timeline-axis"),e.setAttribute("x1","0"),e.setAttribute("y1",n),e.setAttribute("x2",i),e.setAttribute("y2",n),t.appendChild(e);for(let e=0;e<=SpbcTimelineWidget.axisStepsCount;e++){var a=this.timelineStartTimestamp+e/SpbcTimelineWidget.axisStepsCount*s,r=e/SpbcTimelineWidget.axisStepsCount*i,l=document.createElementNS("http://www.w3.org/2000/svg","line"),l=(l.setAttribute("class","spbc-timeline-axis"),l.setAttribute("x1",r),l.setAttribute("y1",n),l.setAttribute("x2",r),l.setAttribute("y2",n+5),t.appendChild(l),document.createElementNS("http://www.w3.org/2000/svg","text")),r=(l.setAttribute("class","spbc-timeline-axis-text"),l.setAttribute("x",r),l.setAttribute("y",n+20),new Date(1e3*a));l.textContent=r.getHours().toString().padStart(2,"0")+":"+r.getMinutes().toString().padStart(2,"0"),t.appendChild(l)}}createEventElement(e,t,i,n){var s=document.createElementNS("http://www.w3.org/2000/svg","g"),t=(s.setAttribute("transform",`translate(${t}, ${i})`),s.setAttribute("data-event",JSON.stringify({...e,user:n})),document.createElementNS("http://www.w3.org/2000/svg","circle"));return t.setAttribute("class","spbc-timeline-event-marker"),t.setAttribute("r",SpbcTimelineWidget.markerRadius),t.style.fill=this.timelineMarkersData[e.event].color,s.appendChild(t),s.addEventListener("mouseenter",this.showEventTooltip.bind(this)),s.addEventListener("mouseleave",this.hideEventTooltip.bind(this)),s}showEventTooltip(e){let{user:t,event:i,time:n}=JSON.parse(e.currentTarget.getAttribute("data-event"));document.getElementById("spbc-timeline-tooltip--user").innerText=t,document.getElementById("spbc-timeline-tooltip--event").innerText=i,document.getElementById("spbc-timeline-tooltip--time").innerText=(r=n,r=new Date(1e3*r),s=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][r.getMonth()],a=r.getDate(),s+` ${String(a).padStart(2,"0")} ${r.getFullYear()} ${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}:`+r.getSeconds().toString().padStart(2,"0"));var s=document.getElementById("spbc-timeline-tooltip"),a=(e.offsetY+35).toString()+"px",r=window.innerWidth,l=s.offsetWidth||165,e=e.clientX;let o=r<e+2*l?e-2*l:e-l;o=o.toString()+"px",s.style.position="absolute",s.style.top=a,s.style.left=o,this.timelineEventTooltip.classList.remove("spbc-timeline-hidden-element"),jQuery("[data-event-type]").filter(function(){return jQuery(this).data("event-type")===i}).addClass("spbc-timelime-highlight-on-tooltip")}hideEventTooltip(){this.timelineEventTooltip.classList.add("spbc-timeline-hidden-element"),jQuery("[data-event-type]").removeClass("spbc-timelime-highlight-on-tooltip")}drawUserTimeline(s){var e=document.getElementById("spbc-timeline-svg"),t=document.getElementById("spbc-timeline-no-data");e.innerHTML="",t.style.display="none";let i=0;5<spbcTimelineWidgetData.found_types.length&&(i=12*(spbcTimelineWidgetData.found_types.length-5));var a=e.parentElement.clientWidth,n=150+i;const r=10+i,l=40,o=40,m=140;let c=a-m-l,d=(n-r-o)/2,p=(e.setAttribute("width",a),e.setAttribute("height",n),document.createElementNS("http://www.w3.org/2000/svg","g"));p.setAttribute("transform",`translate(${m}, ${r+30})`),e.appendChild(p),this.drawTimeAxis(p,c,10+d);a=(this.eventsData[s]||[]).filter(e=>e.time>=this.timelineStartTimestamp&&e.time<=this.currentTimestamp);if(0===a.length)t.style.display="block";else{let n=this.currentTimestamp-this.timelineStartTimestamp;var u=spbcTimelineWidgetData.found_types.length;for(let e=0;e<u;e++){var h=d-SpbcTimelineWidget.userActionsUpstep*e,b=spbcTimelineWidgetData.found_types[e],g=this.timelineMarkersData[b].color,v=document.createElementNS("http://www.w3.org/2000/svg","line"),v=(v.setAttribute("class","spbc-timeline-user-line"),v.setAttribute("x1","0"),v.setAttribute("y1",h),v.setAttribute("x2",c),v.setAttribute("y2",h),v.setAttribute("data-event-type",b),p.appendChild(v),document.createElementNS("http://www.w3.org/2000/svg","circle")),g=(v.setAttribute("class","spbc-timeline-legend-circle"),v.setAttribute("cx",SpbcTimelineWidget.legendCircleX),v.setAttribute("cy",h),v.setAttribute("r",SpbcTimelineWidget.markerRadius),v.style.fill=g,p.appendChild(v),document.createElementNS("http://www.w3.org/2000/svg","text"));g.setAttribute("class","spbc-timeline-legend-text"),g.setAttribute("x",SpbcTimelineWidget.legendTextX),g.setAttribute("y",h),g.setAttribute("text-anchor","start"),g.setAttribute("dominant-baseline","middle"),g.setAttribute("data-event-type",b),g.textContent=b,p.appendChild(g)}a.forEach(e=>{var t=(e.time-this.timelineStartTimestamp)/n*c,i=d+this.timelineMarkersData[e.event].upstep;p.appendChild(this.createEventElement(e,t,i,s))})}}generateMarkersData(e){let t={},i=0,n="default";return e.forEach(e=>{this.timelineKnownEventsData[e]&&this.timelineKnownEventsData[e].color_scheme&&(n=this.timelineKnownEventsData[e].color_scheme),t[e]={color:n,upstep:i},i-=SpbcTimelineWidget.userActionsUpstep}),t}}function spbcTimelineWidgetRender(){var e=new SpbcTimelineWidget;jQuery(function(){jQuery("#spbc-timeline-accordion").accordion({collapsible:!0,active:!1})}),e.render()}
//# sourceMappingURL=spbc-timeline-widget.min.js.map
